# 9ç«  Summary
- Railsã§ã¯ã€ã‚ã‚‹ãƒšãƒ¼ã‚¸ã‹ã‚‰åˆ¥ã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã™ã‚‹ã¨ãã«çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ãƒšãƒ¼ã‚¸ã®çŠ¶æ…‹ã‚’é•·æœŸé–“ä¿æŒã—ãŸã„ã¨ãã¯ã€cookiesãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦æ°¸ç¶šçš„ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã™ã‚‹
- è¨˜æ†¶ãƒˆãƒ¼ã‚¯ãƒ³ã¨è¨˜æ†¶ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«é–¢é€£ä»˜ã‘ã¦ã€æ°¸ç¶šçš„ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå®Ÿç¾ã§ãã‚‹
- cookiesãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«cookiesãªã©ã‚’ä¿å­˜ã§ãã‚‹
- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚‚ã—ãã¯ã‚¯ãƒƒã‚­ãƒ¼ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦æ±ºå®šã•ã‚Œã‚‹
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ã‚¯ãƒƒã‚­ãƒ¼ã‚’ãã‚Œãã‚Œå‰Šé™¤ã™ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãŒå®Ÿç¾ã§ãã‚‹
- ä¸‰é …æ¼”ç®—å­ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€å˜ç´”ãªif-thenæ–‡ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«è¨˜è¿°ã§ãã‚‹

# remember me
(ä»»æ„ã§) ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’è¨˜æ†¶ã—ã¦ãŠãã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èµ·å‹•ã—ãŸå¾Œã§ã‚‚ã™ãã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹æ©Ÿèƒ½ 
æ°¸ç¶šã‚¯ãƒƒã‚­ãƒ¼ (permanent cookies)Â ã‚’ä½¿ã£ã¦ã“ã®æ©Ÿèƒ½ã‚’å®Ÿç¾

## ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ°¸ç¶šåŒ–
è¨˜æ†¶ãƒˆãƒ¼ã‚¯ãƒ³ (remember token)Â ã‚’ç”Ÿæˆã—ã€cookiesãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚‹æ°¸ç¶šçš„cookiesã®ä½œæˆã‚„ã€å®‰å…¨æ€§ã®é«˜ã„è¨˜æ†¶ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ (remember digest)Â ã«ã‚ˆã‚‹ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ã«ã“ã®è¨˜æ†¶ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ´»ç”¨ã—ã¾ã™

sessionãƒ¡ã‚½ãƒƒãƒ‰ã§ä¿å­˜ã—ãŸæƒ…å ±ã¯è‡ªå‹•çš„ã«å®‰å…¨ãŒä¿ãŸã‚Œã¾ã™ãŒã€cookiesãƒ¡ã‚½ãƒƒãƒ‰ã«ä¿å­˜ã™ã‚‹æƒ…å ±ã¯æ®‹å¿µãªãŒã‚‰ãã®ã‚ˆã†ã«ã¯ãªã£ã¦ã„ã¾ã›ã‚“ã€‚

ç‰¹ã«ã€cookiesã‚’æ°¸ç¶šåŒ–ã™ã‚‹ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ã¨ã„ã†æ”»æ’ƒã‚’å—ã‘ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯
è¨˜æ†¶ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¥ªã£ã¦ã€ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã‚Šã™ã¾ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

cookiesã‚’ç›—ã¿å‡ºã™æœ‰åãªæ–¹æ³•ã¯4é€šã‚Šã‚ã‚Šã¾ã™ã€‚ 
1. ç®¡ç†ã®ç”˜ã„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’é€šéã™ã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‘ã‚±ãƒƒãƒˆã‹ã‚‰ãƒ‘ã‚±ãƒƒãƒˆã‚¹ãƒ‹ãƒƒãƒ•ã‚¡ã¨ã„ã†ç‰¹æ®Šãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã§ç›´æ¥cookieã‚’å–ã‚Šå‡ºã™1Â 
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰è¨˜æ†¶ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–ã‚Šå‡ºã™ã€‚
3. ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚° (XSS)Â ã‚’ä½¿ã†ã€‚ 
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ‘ã‚½ã‚³ãƒ³ã‚„ã‚¹ãƒãƒ›ã‚’ç›´æ¥æ“ä½œã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¥ªã„å–ã‚‹ã€‚

- Secure Sockets Layer (SSL)Â ã‚’ã‚µã‚¤ãƒˆå…¨ä½“ã«é©ç”¨ã—ã¦ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã§ä¿è­·ã—ã€ãƒ‘ã‚±ãƒƒãƒˆã‚¹ãƒ‹ãƒƒãƒ•ã‚¡ã‹ã‚‰èª­ã¿å–ã‚‰ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ã„ã¾ã™
- è¨˜æ†¶ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãã®ã¾ã¾ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ã®ã§ã¯ãªãã€è¨˜æ†¶ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€6.3ã§ç”Ÿã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ä»£ã‚ã‚Šã«ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’ä¿å­˜ã—ãŸã®ã¨åŒã˜è€ƒãˆæ–¹ã«åŸºã¥ã„ã¦ã„ã¾ã™2Â ã€‚
- Railsã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«å¯¾ç­–ãŒè¡Œã‚ã‚Œã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ãƒ“ãƒ¥ãƒ¼ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§å…¥åŠ›ã—ãŸå†…å®¹ã‚’ã™ã¹ã¦è‡ªå‹•çš„ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¾ã™ã€‚
- ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã¸ã®ç‰©ç†ã‚¢ã‚¯ã‚»ã‚¹ã«ã‚ˆã‚‹æ”»æ’ƒã«ã¤ã„ã¦ã¯ã€ã•ã™ãŒã«ã‚·ã‚¹ãƒ†ãƒ å´ã§ã®æ ¹æœ¬çš„ãªé˜²è¡›æ‰‹æ®µã‚’è¬›ã˜ã‚‹ã“ã¨ã¯ä¸å¯èƒ½ãªã®ã§ã™ãŒã€äºŒæ¬¡è¢«å®³ã‚’æœ€å°é™ã«ç•™ã‚ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ã€‚å…·ä½“çš„ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ (åˆ¥ç«¯æœ«ãªã©ã§) ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸã¨ãã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¿…ãšå¤‰æ›´ã™ã‚‹ã‚ˆã†ã«ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šé‡è¦ã«ãªã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã¨ãã¯ãƒ‡ã‚¸ã‚¿ãƒ«ç½²å (digital signature)Â ã‚’è¡Œã†ã‚ˆã†ã«ã—ã¾ã™ã€‚

## æ°¸ç¶šçš„ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ–¹é‡
1. è¨˜æ†¶ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¯ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã¦ç”¨ã„ã‚‹ã€‚
2. ãƒ–ãƒ©ã‚¦ã‚¶ã®cookiesã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã™ã‚‹ã¨ãã«ã¯ã€æœ‰åŠ¹æœŸé™ã‚’è¨­å®šã™ã‚‹ã€‚
3. ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒãƒƒã‚·ãƒ¥å€¤ã«å¤‰æ›ã—ã¦ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ã€‚
4. ãƒ–ãƒ©ã‚¦ã‚¶ã®cookiesã«ä¿å­˜ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯æš—å·åŒ–ã—ã¦ãŠãã€‚
5. æ°¸ç¶šãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å«ã‚€cookiesã‚’å—ã‘å–ã£ãŸã‚‰ã€ãã®IDã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ¤œç´¢ã—ã€è¨˜æ†¶ãƒˆãƒ¼ã‚¯ãƒ³ã®cookiesãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®ãƒãƒƒã‚·ãƒ¥å€¤ã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ï¼ˆhas_secure_passwordã¨ä¼¼ã¦ã‚‹ï¼ï¼‰

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ å¾©ç¿’
```$ rails generate migration add_remember_digest_to_users remember_digest:string```

å‰å›ã¨åŒæ§˜ã€ä»Šå›ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åã‚‚_to_usersã§çµ‚ã‚ã£ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã¯ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å¯¾è±¡ãŒ**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®usersãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚ã‚‹ã“ã¨ã‚’Railsã«æŒ‡ç¤º**ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
ä»Šå›ã¯ç¨®é¡=stringã®remember_digestå±æ€§ã‚’è¿½åŠ ã—ã¦ã„ã‚‹ã®ã§ã€ã„ã¤ã‚‚ã®ã‚ˆã†ã«Railsã«ã‚ˆã£ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã¾ã™ (ãƒªã‚¹ãƒˆÂ 9.1)ã€‚

è¨˜æ†¶ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç›´æ¥èª­ã¿å‡ºã™ã“ã¨ã¯ãªã„ã®ã§ (ã‹ã¤ã€ãã†ã•ã›ã¦ã¯ãªã‚‰ãªã„ã®ã§)ã€**remember_digestã‚«ãƒ©ãƒ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚**

## urlsafe_base64
Rubyæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®SecureRandomãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚ã‚‹urlsafe_base64ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€Aâ€“Zã€aâ€“zã€0â€“9ã€"-"ã€"_"ã®ã„ãšã‚Œã‹ã®æ–‡å­— (64ç¨®é¡) ã‹ã‚‰ãªã‚‹é•·ã•22ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’è¿”ã—ã¾ã™ (64ç¨®é¡ãªã®ã§base64ã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™)ã€‚
```
$ rails console
>> SecureRandom.urlsafe_base64
=> "q5lt38hQDc_959PVoo6b7A"
```
ä»Šå›ã¯è¨˜æ†¶ãƒˆãƒ¼ã‚¯ãƒ³ã«åˆ©ç”¨

## attr_accessor å¾©ç¿’
ã€Œä»®æƒ³ã®ã€å±æ€§ã‚’ä½œæˆ
attr_accessorè§£èª¬
- [RoRTæœ¬æ–‡](https://railstutorial.jp/chapters/rails_flavored_ruby?version=5.1#sec-a_user_class)
- [ã‚‰ãã ğŸ«ã«ã‚‚ã§ãã‚‹Railsãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ï½œ4.4ï¼ˆã¨4.5ï¼‰](https://rakuda3desu.net/rakudas-rails-tutorial4-4/)

## ã‚³ãƒ¼ãƒ‰è§£èª¬
```rb
class User < ApplicationRecord
Â Â #remember_tokenå±æ€§ã‚’Userã‚¯ãƒ©ã‚¹ã«å®šç¾©
Â Â attr_accessor :remember_token
Â Â .
Â Â .
Â Â .
Â Â def remember
Â Â Â Â #remember_tokenã«è¦ç´ ã‚’ä»£å…¥
Â Â Â Â #ï¼ˆselfã‚’ä»˜ã‘ã‚‹ã¨ã‚¯ãƒ©ã‚¹å¤‰æ•°ã«ãªã‚‹â†’ã“ã®å ´åˆUser.remember_tokenã¨åŒæ„ï¼‰
Â Â Â Â self.remember_token = ...
Â Â Â Â #validationã‚’ç„¡è¦–ã—ã¦æ›´æ–°ï¼ˆå¼•æ•°ã«ãƒãƒƒã‚·ãƒ¥ã§æ›´æ–°ã—ãŸã„å±æ€§ã¨å€¤ã‚’ã‚»ãƒƒãƒˆï¼‰
Â Â Â Â update_attribute(:remember_digest, ...)
Â Â end
end
```
- selfã¨ã„ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã‚ãªã„ã¨ã€Rubyã«ã‚ˆã£ã¦remember_tokenã¨ã„ã†åå‰ã®ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ãŒä½œæˆã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ ( = Rubyã«ãŠã‘ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…éƒ¨ã¸ã®è¦ç´ ä»£å…¥)
- update_attributeãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦è¨˜æ†¶ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’æ›´æ–°ã—ã¦ã„ã¾ã™ã€‚6.1.5ã§èª¬æ˜ã—ãŸã‚ˆã†ã«ã€**update_attributeãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç´ é€šã‚Šã•ã›ã¾ã™ã€‚**ä»Šå›ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã®ã§ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç´ é€šã‚Šã•ã›ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

### çœç•¥ã•ã‚Œã‚‹selfã¨çœç•¥ã§ããªã„self

```rb
def remember
Â Â Â Â #remember_tokenã«ã€€User.new_tokenã‚’ä»£å…¥
Â Â Â Â self.remember_token = User.new_token
Â Â Â Â #validationã‚’ç„¡è¦–ã—ã¦æ›´æ–°ã€€ï¼ˆ:remember_digestå±æ€§ã«ãƒãƒƒã‚·ãƒ¥åŒ–ã—ãŸremember_tokenã‚’ï¼‰
Â Â Â Â update_attribute(:remember_digest, User.digest(remember_token))
Â Â end
```
selfã®æœ‰ç„¡ã«ã‚ˆã£ã¦ã€€self.remember_tokenï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ï¼‰ã€€remember_tokenï¼ˆãƒ¡ã‚½ãƒƒãƒ‰å†…ã®å¤‰æ•°ï¼‰ã«ãªã£ã¡ã‚ƒã†ã‹ã‚‰â€¨30è¡Œç›®ã®(remember_token)ã«self.ã¤ã‘ãªã„ã¨ã˜ã‚ƒãªã„ï¼Ÿã£ã¦ã„ã†è©±ãŒå‡ºã¾ã—ã¦â€¨**æœ¬æ¥ã¯selfã¤ã„ã¦ã‚‹ã‘ã©çœç•¥**ã•ã‚Œã¦ã„ã‚‹ã‚ˆï¼ã¨ã„ã†ã“ã¨ã®ã‚ˆã†ã§ã™ã€‚â€¨
c.f. [rubyã§selfã‚’çœç•¥ã§ãã‚‹æ™‚ã€ã§ããªã„æ™‚](https://qiita.com/akira-hamada/items/4132d2fda7e420073ab7)

[ãƒªã‚¹ãƒˆ9.4  ã‚³ãƒ¼ãƒ‰](https://railstutorial.jp/chapters/advanced_login?version=5.1#code-token_digest_self)
```rb
class User < ApplicationRecord
Â Â .
Â Â .
Â Â .
Â Â # æ¸¡ã•ã‚ŒãŸæ–‡å­—åˆ—ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¿”ã™
Â Â #User.digest(string)ã¨åŒã˜æ„å‘³
  # ã“ã“ã§ã®self = Userã‚¯ãƒ©ã‚¹
Â Â def self.digest(string)
Â Â Â Â cost = ActiveModel::SecurePassword.min_cost ? BCrypt::Engine::MIN_COST :
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â BCrypt::Engine.cost
Â Â Â Â BCrypt::Password.create(string, cost: cost)
Â Â end
Â 
Â Â # ãƒ©ãƒ³ãƒ€ãƒ ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™
Â Â #User.new_tokenã¨åŒã˜æ„å‘³
Â Â def self.new_token
Â Â Â Â SecureRandom.urlsafe_base64
Â Â end
Â Â .
Â Â .
Â Â .
end
```

[ãƒªã‚¹ãƒˆ9.5 ã‚³ãƒ¼ãƒ‰](https://railstutorial.jp/chapters/advanced_login?version=5.1#code-token_digest_class_self)
```rb
class User < ApplicationRecord
Â Â .
Â Â .
Â Â .
Â Â #ã“ã®ã‚¹ã‚³ãƒ¼ãƒ—ã®ä¸­ã«æ›¸ã‹ã‚ŒãŸãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã«ãªã‚‹
Â Â class << self
Â Â Â Â # æ¸¡ã•ã‚ŒãŸæ–‡å­—åˆ—ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¿”ã™
Â Â Â Â def digest(string)
Â Â Â Â Â Â cost = ActiveModel::SecurePassword.min_cost ? BCrypt::Engine::MIN_COST :
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â BCrypt::Engine.cost
Â Â Â Â Â Â BCrypt::Password.create(string, cost: cost)
Â Â Â Â end
Â 
Â Â Â Â # ãƒ©ãƒ³ãƒ€ãƒ ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™
Â Â Â Â def new_token
Â Â Â Â Â Â SecureRandom.urlsafe_base64
Â Â Â Â end
Â Â end
```

## cookiesãƒ¡ã‚½ãƒƒãƒ‰
æ°¸ç¶šã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹
sessionã®ã¨ãã¨åŒæ§˜ã«ãƒãƒƒã‚·ãƒ¥ã¨ã—ã¦æ‰±ãˆã¾ã™ã€‚
å€‹åˆ¥ã®cookiesã¯ã€ï¼‘ã¤ã®valueÂ (å€¤) ã¨ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®expiresÂ (æœ‰åŠ¹æœŸé™) ã‹ã‚‰ã§ãã¦ã„ã¾ã™ã€‚æœ‰åŠ¹æœŸé™ã¯çœç•¥å¯èƒ½ã§ã™ã€‚

e.g. 20å¹´å¾Œã«æœŸé™åˆ‡ã‚Œã«ãªã‚‹è¨˜æ†¶ãƒˆãƒ¼ã‚¯ãƒ³ã¨åŒã˜å€¤ã‚’cookieã«ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€æ°¸ç¶šçš„ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹

```rb
#20å¹´å¾Œã«æœŸé™åˆ‡ã‚Œã«ãªã‚‹è¨­å®š
cookies[:remember_token] = { value:Â Â  remember_token,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  expires: 20.years.from_now.utc }
Â 
#ã‚ˆãä½¿ã‚ã‚Œã‚‹è¨­å®šãªã®ã§permanentã¨ã„ã†å°‚ç”¨ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
#20å¹´å¾Œã«æœŸé™åˆ‡ã‚Œã«ãªã‚‹è¨­å®šã®ã‚³ãƒ¼ãƒ‰ã‚’æ›´ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«
cookies.permanent[:remember_token] = remember_token
```

c.f. [ãŸã®ã—ã„OSSã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: Let's read "cookies"ğŸª
](https://qiita.com/coe401_/items/ad7dc2f3e319c5beaf40)

# ç½²åä»˜ãcookie
cookieã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã™ã‚‹å‰ã«å®‰å…¨ã«æš—å·åŒ–ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™8Â ã€‚
b/c IDãŒç”Ÿã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦cookiesã«ä¿å­˜ã•ã‚Œã¦ã—ã¾ã†ã®ã‚’é˜²ããŸã‚

```rb
#ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’cookiesã«ä¿å­˜
cookies[:user_id] = user.id
 
#â†‘ã“ã®ã¾ã¾ã§ã¯IDãŒç”Ÿã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦cookiesã«ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€Œç½²åä»˜ãcookieã€ã‚’ä½¿ã„æš—å·åŒ–ã™ã‚‹
#signedã¯ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã¨æš—å·åŒ–ã‚’ã¾ã¨ã‚ã¦å®Ÿè¡Œã—ã¦ãã‚Œã‚‹
cookies.signed[:user_id] = user.id
 
#ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨è¨˜æ†¶ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒšã‚¢ã§æ‰±ã†ã®ã§cookieã‚‚æ°¸ç¶šåŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
#ã‚ˆã£ã¦signedã¨permanentã‚’ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã§ç¹‹ã„ã§ä½¿ã†
cookies.permanent.signed[:user_id] = user.id
 
#cookiesã‚’è¨­å®šã—ã¦ãŠãäº‹ã§ã€cookiesã‹ã‚‰userã‚’å–ã‚Šå‡ºã™ã“ã¨ãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚‹
#è‡ªå‹•çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®cookiesã®æš—å·ãŒè§£é™¤ã•ã‚Œå…ƒã«æˆ»ã‚‹
User.find_by(id: cookies.signed[:user_id])
```

# ãƒªã‚¹ãƒˆ9.6 ã‚³ãƒ¼ãƒ‰è§£èª¬
```rb
    # æ¸¡ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã¨ä¸€è‡´ã—ãŸã‚‰trueã‚’è¿”ã™
    def authenticated?(remember_token)
      # is_password?ã®å¼•æ•°remember_token ã¯ãƒ¡ã‚½ãƒƒãƒ‰å†…ã®ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚’å‚ç…§
      # remember_digest = self.remember_digest
      BCrypt::Password.new(remember_digest).is_password?(remember_token)
    end
```
# ãƒªã‚¹ãƒˆ9.8 è§£èª¬
æ°¸ç¶šã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å ´åˆã¯ã€session[:user_id]ãŒå­˜åœ¨ã™ã‚Œã°ä¸€æ™‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–ã‚Šå‡ºã—ã€
ãã‚Œä»¥å¤–ã®å ´åˆã¯cookies[:user_id]ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–ã‚Šå‡ºã—ã¦ã€å¯¾å¿œã™ã‚‹æ°¸ç¶šã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

```@current_user ||= User.find_by(id: session[:user_id])```

```rb
# æ¯”è¼ƒ (==) ã§ã¯ãªã
# (ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä»£å…¥ã—ãŸçµæœ) ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚Œã°ã€ã¨ã„ã†æ„å‘³
if (user_id = session[:user_id])
  @current_user ||= User.find_by(id: user_id)
elsif (user_id = cookies.signed[:user_id])
  #userã«ã€€cookiesã‹ã‚‰å–ã‚Šå‡ºã—ãŸidã®å€¤ãŒUser.idã¨ä¸€è‡´ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä»£å…¥
  user = User.find_by(id: user_id)
  if user && user.authenticated?(cookies[:remember_token])
    log_in user
    @current_user = user
  end
end
```

# FATAL: Listen error ã®è§£æ±ºæ³•
FATAL: Listen error ãŒç™ºç”Ÿã—ã€rails sever ãŒèµ·å‹•ã§ããªããªã£ãŸï¼ˆconsoleã¯èµ·å‹•ã§ãã‚‹ï¼‰

[rails consoleãŒèµ·å‹•ã§ããªã„æ™‚ã®å¯¾å‡¦æ³•ï¼ˆã€ŒFATAL: Listen errorã€ã‚¨ãƒ©ãƒ¼ç·¨ï¼‰](https://qiita.com/yn-misaki/items/c850a07f7858437e4d26)

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–ã‚Šæ¶ˆã—ã€€user.forget
user.forgetãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦ã€user.rememberãŒå–ã‚Šæ¶ˆã•ã‚Œã¾ã™ã€‚
å…·ä½“çš„ã«ã¯ã€è¨˜æ†¶ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’nilã§æ›´æ–°ã—ã¾ã™

## assert_equal
assert_equalã®å¼•æ•°ã¯ã€ŒæœŸå¾…ã™ã‚‹å€¤,Â å®Ÿéš›ã®å€¤ã€ã®é †åºã§æ›¸ãç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
```assert_equal <expected>, <actual>```

## ã“ã®æ™‚ç‚¹ã§testãŒãƒ‘ã‚¹ã—ãªã„ï¼ï¼
åŸå› : ```include SessionHelper``` ãŒãªã‹ã£ãŸ
c.f. https://teratail.com/questions/131553

ã“ã‚Œè¦‹è½ã¨ã—ã¦ã¦3h ãã‚‰ã„ãã‚‹ãã‚‹ã—ã¦ãŸã€ã€

# Heroku ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰
```heroku maintenance:on``` : ã‚ªãƒ³
```heroku maintenance:off``` : ã‚ªãƒ•
Herokuã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚‚ã€Herokuä¸Šã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã¾ã§ã®é–“ã¯ä¸€æ™‚çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„çŠ¶æ…‹ (ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸) ã«ãªã‚‹
ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®å¤šã„æœ¬ç•ªã‚µã‚¤ãƒˆã§ã¯ã€ã“ã®ã‚ˆã†ãªå¤‰æ›´ã‚’è¡Œã†å‰ã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚ªãƒ³ã«ã—ã¦ãŠãã“ã¨ãŒä¸€èˆ¬çš„

